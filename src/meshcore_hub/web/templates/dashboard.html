{% extends "base.html" %}
{% from "macros/icons.html" import icon_nodes, icon_advertisements, icon_messages, icon_alert, icon_channel %}

{% block title %}Dashboard - {{ network_name }}{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold">Dashboard</h1>
</div>

{% if api_error %}
<div class="alert alert-warning mb-6">
    {{ icon_alert("stroke-current shrink-0 h-6 w-6") }}
    <span>Could not fetch data from API: {{ api_error }}</span>
</div>
{% endif %}

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 animate-stagger">
    <!-- Total Nodes -->
    <div class="stat bg-base-100 rounded-box shadow">
        <div class="stat-figure text-primary">
            {{ icon_nodes("h-8 w-8") }}
        </div>
        <div class="stat-title">Total Nodes</div>
        <div class="stat-value text-primary">{{ stats.total_nodes }}</div>
        <div class="stat-desc">All discovered nodes</div>
    </div>

    <!-- Advertisements (7 days) -->
    <div class="stat bg-base-100 rounded-box shadow">
        <div class="stat-figure text-secondary">
            {{ icon_advertisements("h-8 w-8") }}
        </div>
        <div class="stat-title">Advertisements</div>
        <div class="stat-value text-secondary">{{ stats.advertisements_7d }}</div>
        <div class="stat-desc">Last 7 days</div>
    </div>

    <!-- Messages (7 days) -->
    <div class="stat bg-base-100 rounded-box shadow">
        <div class="stat-figure text-accent">
            {{ icon_messages("h-8 w-8") }}
        </div>
        <div class="stat-title">Messages</div>
        <div class="stat-value text-accent">{{ stats.messages_7d }}</div>
        <div class="stat-desc">Last 7 days</div>
    </div>
</div>

<!-- Activity Charts -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 animate-stagger">
    <!-- Node Count Chart -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-base">
                {{ icon_nodes("h-5 w-5") }}
                Total Nodes
            </h2>
            <p class="text-xs opacity-70">Over time (last 7 days)</p>
            <div class="h-32">
                <canvas id="nodeChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Advertisements Chart -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-base">
                {{ icon_advertisements("h-5 w-5") }}
                Advertisements
            </h2>
            <p class="text-xs opacity-70">Per day (last 7 days)</p>
            <div class="h-32">
                <canvas id="advertChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Messages Chart -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-base">
                {{ icon_messages("h-5 w-5") }}
                Messages
            </h2>
            <p class="text-xs opacity-70">Per day (last 7 days)</p>
            <div class="h-32">
                <canvas id="messageChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Additional Stats -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-stagger">
    <!-- Recent Advertisements -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">
                {{ icon_advertisements("h-6 w-6") }}
                Recent Advertisements
            </h2>
            {% if stats.recent_advertisements %}
            <div class="overflow-x-auto">
                <table class="table table-compact w-full">
                    <thead>
                        <tr>
                            <th>Node</th>
                            <th>Type</th>
                            <th class="text-right">Received</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ad in stats.recent_advertisements %}
                        <tr>
                            <td>
                                <a href="/nodes/{{ ad.public_key }}" class="link link-hover">
                                    <div class="font-medium">{{ ad.friendly_name or ad.name or ad.public_key[:12] + '...' }}</div>
                                </a>
                                {% if ad.friendly_name or ad.name %}
                                <div class="text-xs opacity-50 font-mono">{{ ad.public_key[:12] }}...</div>
                                {% endif %}
                            </td>
                            <td>
                                {% if ad.adv_type and ad.adv_type|lower == 'chat' %}
                                <span title="Chat">üí¨</span>
                                {% elif ad.adv_type and ad.adv_type|lower == 'repeater' %}
                                <span title="Repeater">üì°</span>
                                {% elif ad.adv_type and ad.adv_type|lower == 'room' %}
                                <span title="Room">ü™ß</span>
                                {% elif ad.adv_type %}
                                <span title="{{ ad.adv_type }}">üìç</span>
                                {% else %}
                                <span class="opacity-50">-</span>
                                {% endif %}
                            </td>
                            <td class="text-right text-sm opacity-70">{{ ad.received_at.split('T')[1][:8] if ad.received_at else '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-sm opacity-70">No advertisements recorded yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Channel Messages -->
    {% if stats.channel_messages %}
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">
                {{ icon_channel("h-6 w-6") }}
                Recent Channel Messages
            </h2>
            <div class="space-y-4">
                {% for channel, messages in stats.channel_messages.items() %}
                <div>
                    <h3 class="font-semibold text-sm mb-2 flex items-center gap-2">
                        <span class="badge badge-info badge-sm">CH{{ channel }}</span>
                        Channel {{ channel }}
                    </h3>
                    <div class="space-y-1 pl-2 border-l-2 border-base-300">
                        {% for msg in messages %}
                        <div class="text-sm">
                            <span class="text-xs opacity-50">{{ msg.received_at.split('T')[1][:5] if msg.received_at else '' }}</span>
                            <span class="break-words" style="white-space: pre-wrap;">{{ msg.text }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', path='js/charts.js') }}"></script>
<script>
(function() {
    var nodeData = {{ node_count_json | safe }};
    var advertData = {{ advert_activity_json | safe }};
    var messageData = {{ message_activity_json | safe }};
    initDashboardCharts(nodeData, advertData, messageData);
})();
</script>
{% endblock %}
